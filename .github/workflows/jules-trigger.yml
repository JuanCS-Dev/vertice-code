name: Jules Auto-Fix

on:
  issues:
    types: [labeled, edited]
  workflow_dispatch:
    inputs:
      issues:
        description: 'Comma-separated issue numbers (e.g., 22,23,33)'
        required: true
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  jules-work:
    if: github.event.label.name == 'jules' || contains(github.event.issue.labels.*.name, 'jules')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue info
        id: issue
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          echo "title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Invoke Jules
        uses: google-labs-code/jules-action@v1.0.0
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          model: "gemini-2.0-flash-exp" # Force a faster/better model if supported
          prompt: |
            ACT AS: Senior Python Developer (Vertice-Code)

            You are tasked with resolving Issue #${{ steps.issue.outputs.number }}: "${{ steps.issue.outputs.title }}"

            CONTEXT & STANDARDS:
            1. READ `AGENTS.md` in the root directory immediately. It contains your persona, coding style, and mandatory commands.
            2. READ `CONSTITUICAO_VERTICE_v3.0.md` if available for protocol compliance.

            ISSUE DESCRIPTION:
            ================================================================
            ${{ steps.issue.outputs.body }}
            ================================================================

            EXECUTION PROTOCOL:
            1. ANALYZE SCOPE: Check the issue description for "Scope (LIMITED)".
               - CRITICAL: Do NOT touch files outside this list unless absolutely necessary for imports/types.
               - If "Out of Scope" is defined, respect it religiously.

            2. ENVIRONMENT:
               - The environment is pre-configured. Use `pip install -e .` if needed.

            3. IMPLEMENTATION:
               - Write idiomatic, async Python 3.11+.
               - Use specific exceptions (no `except Exception`).
               - Add unit tests for your changes in `tests/unit/`.

            4. VERIFICATION (Mandatory):
               - Run: `black vertice_cli/ vertice_tui/ vertice_core/`
               - Run: `ruff check --fix .`
               - Run: `pytest tests/unit/ -v -x --timeout=60`
               - If tests fail, FIX THEM before submitting.

            5. DELIVERABLE:
               - Create a Pull Request linked to Issue #${{ steps.issue.outputs.number }}.
               - Title format: "fix(component): description" (or feat/refactor as appropriate).

            GO.
