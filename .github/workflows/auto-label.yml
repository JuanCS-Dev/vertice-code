name: Auto Label Issues

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

permissions:
  issues: write
  pull-requests: write

jobs:
  label-issues:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues'

    steps:
    - name: Label by title prefix
      uses: actions/github-script@v7
      with:
        script: |
          const title = context.payload.issue.title.toLowerCase();
          const labels = [];

          // Priority detection
          if (title.includes('[critical]') || title.includes('critical')) {
            labels.push('critical');
          } else if (title.includes('[high]')) {
            labels.push('high');
          } else if (title.includes('[medium]')) {
            labels.push('medium');
          } else if (title.includes('[low]')) {
            labels.push('low');
          }

          // Type detection
          if (title.includes('[bug]')) {
            labels.push('bug');
          } else if (title.includes('[feature]')) {
            labels.push('enhancement');
          } else if (title.includes('[security]')) {
            labels.push('security');
          } else if (title.includes('[jules]')) {
            labels.push('jules');
          }

          // Component detection
          if (title.includes('cli') || title.includes('vertice_cli')) {
            labels.push('vertice-cli');
          } else if (title.includes('tui') || title.includes('vertice_tui')) {
            labels.push('vertice-tui');
          } else if (title.includes('agent')) {
            labels.push('agents');
          }

          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: labels
            });
          }

  label-prs:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - uses: actions/checkout@v4

    - name: Label by files changed
      uses: actions/github-script@v7
      with:
        script: |
          const { data: files } = await github.rest.pulls.listFiles({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.payload.pull_request.number
          });

          const labels = new Set();

          for (const file of files) {
            if (file.filename.startsWith('vertice_cli/')) {
              labels.add('vertice-cli');
            }
            if (file.filename.startsWith('vertice_tui/')) {
              labels.add('vertice-tui');
            }
            if (file.filename.startsWith('vertice_core/')) {
              labels.add('vertice-core');
            }
            if (file.filename.startsWith('agents/') || file.filename.includes('/agents/')) {
              labels.add('agents');
            }
            if (file.filename.startsWith('tests/')) {
              labels.add('testing');
            }
            if (file.filename.startsWith('docs/') || file.filename.endsWith('.md')) {
              labels.add('documentation');
            }
            if (file.filename.includes('security') || file.filename.includes('vault')) {
              labels.add('security');
            }
          }

          if (labels.size > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              labels: Array.from(labels)
            });
          }
